# Day 13: Post-Exploitation, Persistence, & Evasion

## Objective
To simulate the critical actions an attacker takes *after* gaining initial access to a target. This lab focused on three core post-exploitation pillars: establishing persistence to survive a reboot, escalating privileges to dump credentials, and covering tracks by clearing event logs. The primary lesson was learning how to adapt and bypass modern host-based security controls like Windows Defender.

## Tools Used
-   Metasploit Framework (`msfconsole`)
-   Meterpreter Payload
-   `exploit/windows/local/persistence` module
-   Meterpreter commands: `ps`, `migrate`, `getuid`, `hashdump`, `clearev`, `reboot`

## Steps & Evidence

This lab began with a stable Meterpreter shell on my Windows Server 2019 Domain Controller, achieved via the client-side attack developed on Day 12.

1.  **Attempted Credential Dumping & EDR Evasion:** My first objective was to dump password hashes.
    *   **Initial `hashdump` attempt:** I issued the `hashdump` command from the initial Meterpreter shell.
    *   **Blue Team Defense:** Almost instantly, the Meterpreter session died. This was a perfect real-world demonstration of an EDR/AV solution at work. Windows Defender's behavioral analysis detected the suspicious attempt to access the memory of the `lsass.exe` process and immediately terminated my payload's process.

2.  **Bypassing Defenses with Process Migration:** Faced with a working defense, I adapted my tactics.
    *   I acquired a new Meterpreter shell by re-executing my payload.
    *   This time, my **first action** was to perform process migration to evade detection. I used the `ps` command to list active processes, identified a stable, 64-bit process running as SYSTEM (`svchost.exe`), and used the `migrate [PID]` command to inject the Meterpreter payload into that trusted process's memory space.
    *   The migration was successful, effectively hiding my presence from the EDR.

3.  **Achieving Objectives:** Now operating from within a legitimate process, I successfully executed my primary objectives:
    *   **Credential Dumping:** I ran `hashdump` again. This time, it worked perfectly, dumping the NTLM hashes for all users on the Domain Controller, including the `Administrator` and `krbtgt` accounts.
    *   **Covering Tracks:** I ran the `clearev` command, which successfully wiped the Application, System, and Security event logs, hindering a potential forensic investigation.

4.  **Establishing Persistence:** I used the modern `exploit/windows/local/persistence` module in Metasploit. I configured it to use my active Meterpreter session to install a new, persistent backdoor that would connect back to my Kali machine on port `4445` whenever a user logged into the server.

### Evidence

*The initial `hashdump` attempt being shut down by Windows Defender. A textbook example of an Endpoint Detection and Response (EDR) system terminating a malicious process.*
![Hashdump Fail vs Defender](hashdump-fail-defender.png)
<img width="958" height="1079" alt="Screenshot 2025-08-19 153340" src="https://github.com/user-attachments/assets/070576e8-a2c2-4d8d-8546-4ade5069b4a1" />

*The complete, successful attack chain. I migrated my Meterpreter payload into a trusted process (`explorer.exe`), which then allowed me to successfully dump password hashes and clear the event logs without being detected.*
![Migrate and Win](migrate-and-win.png)
<img width="954" height="1079" alt="Screenshot 2025-08-19 154303" src="https://github.com/user-attachments/assets/99593dc6-cac0-4811-bf04-41e2ceb2d8d0" />

## Challenges & Reflection

This lab was an electrifying demonstration of the constant battle between attackers (Red Team) and defenders (Blue Team).

-   **The Power of Modern Defenses:** I was genuinely impressed to see the default Windows Defender instance instantly detect and kill a standard Metasploit payload based on its *behavior*. This proved that signature-based antivirus is old news; modern security is about detecting malicious actions.
-   **"Try Harder" in Practice:** My initial failure was the most valuable lesson. It forced me to think like an attacker and ask, "How do I bypass this?" Learning and executing process migration was the answer. It transformed a failed attack into a successful one and was a powerful lesson in AV evasion.
-   **The Value of SYSTEM:** Obtaining the `NT AUTHORITY\SYSTEM` privilege level is the "keys to the kingdom." From there, dumping credentials with `hashdump` was trivial. This reinforces why preventing privilege escalation is a top priority for defenders. Seeing the `krbtgt` hash, which is used for creating Golden Tickets in a Kerberos attack, was a stark reminder of how quickly a single host compromise can threaten an entire Active Directory domain.

This lab transitioned my understanding from merely "getting a shell" to the strategic objectives an attacker has once inside a network. It was a perfect lesson in adaptation, evasion, and the true power of post-exploitation.
